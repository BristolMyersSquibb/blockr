<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>3. Case study: create a plot block • blockr</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="3. Case study: create a plot block">
<link href="https://raw.githubusercontent.com/rstudio/bslib/main/inst/components/dist/card/card.min.js">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@latest/font/bootstrap-icons.css">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">blockr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2.9031</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/blockr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-developer-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Developer guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-developer-guides">
<li><a class="dropdown-item" href="../articles/data-blocks.html">Data blocks</a></li>
    <li><a class="dropdown-item" href="../articles/registry.html">Block registry</a></li>
    <li><a class="dropdown-item" href="../articles/plot-block.html">How to create a plot block?</a></li>
    <li><a class="dropdown-item" href="../articles/new-field.html">How to create a new field?</a></li>
    <li><a class="dropdown-item" href="../articles/blockr-examples.html">More examples</a></li>
    <li><a class="dropdown-item" href="../articles/internals.html">Internals</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><h6 class="dropdown-header" data-toc-skip>blockr 0.0.2.9031</h6></li>
    <li><h6 class="dropdown-header" data-toc-skip>blockr 0.0.2</h6></li>
    <li><h6 class="dropdown-header" data-toc-skip>blockr 0.0.1.9000</h6></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="plot-block_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="plot-block_files/bslib-component-js-0.8.0/components.min.js"></script><script src="plot-block_files/bslib-component-js-0.8.0/web-components.min.js" type="module"></script><link href="plot-block_files/bslib-component-css-0.8.0/components.css" rel="stylesheet">
<script src="plot-block_files/bslib-tag-require-0.8.0/tag-require.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>3. Case study: create a plot block</h1>
            
      

      <div class="d-none name"><code>plot-block.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we show how to create a plot block
<strong>layer</strong> by layer with the <a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a>
package.</p>
<div class="m-3 p-2 text-warning-emphasis bg-warning-subtle border border-warning-subtle rounded-3">Before going further, please be sure to read the S3 chapter of advanced R: https://adv-r.hadley.nz/s3.html.</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="section level3">
<h3 id="anatomy-of-a-ggplot2-plot">Anatomy of a <code>{ggplot2}</code> plot<a class="anchor" aria-label="anchor" href="#anatomy-of-a-ggplot2-plot"></a>
</h3>
<p>With <a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a>, plots are built <strong>layer</strong>
by <strong>layer</strong>. It all starts with <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code>
which initialises the ggplot object passing optional data and mappings.
Then, we add <strong>geoms</strong>, like <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point()</a></code>.
Geoms also accept custom <strong>mappings</strong> (overwrite mappings
passed to the first <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code> call), data, as well as other
parameters. As a result, there are many ways to build a ggplot:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># 1</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="sc">&lt;</span>DATA<span class="sc">&gt;</span>, <span class="at">mapping =</span> <span class="sc">&lt;</span>MAPPING<span class="sc">&gt;</span>) <span class="sc">+</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co"># 2</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="sc">&lt;</span>DATA<span class="sc">&gt;</span>) <span class="sc">+</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">mapping =</span> <span class="sc">&lt;</span>MAPPING<span class="sc">&gt;</span>) <span class="sc">+</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">mapping =</span> <span class="sc">&lt;</span>MAPPING<span class="sc">&gt;</span>)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="co"># 3</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="sc">&lt;</span>DATA<span class="sc">&gt;</span>, <span class="at">mapping =</span> <span class="sc">&lt;</span>MAPPING<span class="sc">&gt;</span>) <span class="sc">+</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="sc">&lt;</span>DATA<span class="sc">&gt;</span>, <span class="at">mapping =</span> <span class="sc">&lt;</span>MAPPING<span class="sc">&gt;</span>)</span></code></pre></div>
<p>In this tutorial, we go for the first option.</p>
</div>
<div class="section level3">
<h3 id="to-do-list">To do list<a class="anchor" aria-label="anchor" href="#to-do-list"></a>
</h3>
<p>What do we need to create?</p>
<p>It seems obvious to add new <code>ggplot_block()</code> and geom
<strong>constructors</strong>. On the Shiny side, we have to handle the
plot output element. Remember that the <code><a href="../reference/server_output.html">server_output()</a></code>
<strong>generic</strong> is defined in the <a href="https://bristolmyerssquibb.github.io/blockr">blockr</a>
<code>server.R</code> script. It supports tables with
<code><a href="../reference/server_output.html">server_output.block()</a></code> and plots with
<code><a href="../reference/server_output.html">server_output.plot_block()</a></code>. Therefore, we don’t need to
create another S3 method and have to make sure our new plot block
inherits from the <code>plot_block</code> class to
<strong>dispatch</strong> to the correct method. Most of our work will
be on the block side since we’ll have to generate the plot layer by
layer, each layer being a block. Before writing this vignette,
<a href="https://bristolmyerssquibb.github.io/blockr">blockr</a> did not support layer by layer plots. This new
concept required to expose a new way of combining plot expressions to
generate the entire stack code. With the previous infrastructure, we
could only do:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">block_1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">block_2</span></span></code></pre></div>
<p>However, handling <a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a> grammar requires to be able
to combine with <code>+</code> such as:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">plot_block</span> <span class="op">+</span> <span class="va">layer_block</span></span></code></pre></div>
<p>All the process is described in the following, which should highlight
the <strong>flexibility</strong> provided by <a href="https://bristolmyerssquibb.github.io/blockr">blockr</a>.</p>
</div>
<div class="section level3">
<h3 id="new-block-helpers">New block helpers<a class="anchor" aria-label="anchor" href="#new-block-helpers"></a>
</h3>
<div class="m-3 p-2 text-warning-emphasis bg-warning-subtle border border-warning-subtle rounded-3">What is described in the following may not be necessary in all cases and 
  is specific to `{ggplot2}` which brings specific syntax like `+`. 
  `{blockr}` now supports layer by layer plots and you theoretically only have 
  to create the corresponding blocks (See next section). 
  What we show below is sort of 'making off' that will serve to advanced users.</div>
<div class="section level4">
<h4 id="new-evaluate_block-method">New <code>evaluate_block()</code> method<a class="anchor" aria-label="anchor" href="#new-evaluate_block-method"></a>
</h4>
<p>We define below a new way to pass data to a block layer, through the
<code><a href="../reference/evaluate_block.html">evaluate_block.plot_layer_block()</a></code> method. As a consequence,
these block layer must have the <code>plot_layer_block</code> class:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evaluate_block.plot_layer_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dots.html" class="external-link">...length</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0L</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">data</span>, <span class="st">"ggplot"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span><span class="va">data</span> <span class="op">+</span> <span class="va">expr</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>expr <span class="op">=</span> <span class="fu"><a href="../reference/generate_code.html">generate_code</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Compared to <code>evaluate_block.transform_block()</code>, we simply
replaced <code>%&gt;%</code> by <code>+</code>. Nothing more! As a side
note, if you had to develop your own method in a test script, you could
register it and test it with:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">.S3method</span>(<span class="st">"&lt;GENERIC&gt;"</span>, <span class="st">"&lt;CLASS&gt;"</span>, <span class="sc">&lt;</span>METHOD<span class="sc">&gt;</span>)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="generate-a-valid-stack-code">Generate a valid stack code<a class="anchor" aria-label="anchor" href="#generate-a-valid-stack-code"></a>
</h4>
<p>Before adding the layer by layer plot blocks,
<code><a href="../reference/new_stack.html">generate_code.stack()</a></code> was:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_code.stack</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">binary_substitute</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">binary_substitute</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">generate_code</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This method leverages <code><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce()</a></code> which applies a
<strong>binary function</strong> to combine elements of a vector (from
left to right by default). For instance, we could sum the 3 first
integers with:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">`+`</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/new_stack.html">generate_code.stack()</a></code> successively combines all the
block expressions given by <code>lapply(x, generate_code)</code>. If
there are 3 blocks in the stack:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_stack.html">new_stack</a></span><span class="op">(</span><span class="va">new_dataset_block</span>, <span class="va">new_filter_block</span>, <span class="va">new_select_block</span><span class="op">)</span></span></code></pre></div>
<p><code>binary_substitute</code> is called twice:</p>
<ul>
<li>Once to combine x being <code>&lt;dataset_block_EXPR&gt;</code> (the
data block expression) and y being
<code>&lt;filter_block_EXPR&gt;</code>, to give
<code>&lt;dataset_block_EXPR&gt; %&gt;% &lt;filter_block_EXPR&gt;</code>.</li>
<li>Then to combine the previous result, namely x, equal to
<code>&lt;dataset_block_EXPR&gt; %&gt;% &lt;filter_block_EXPR&gt;</code>
with y equal to <code>&lt;select_block_EXPR&gt;</code>.</li>
<li>This ultimately yields:
<code>&lt;dataset_block_EXPR&gt; %&gt;% &lt;filter_block_EXPR&gt; %&gt;% &lt;select_block_EXPR&gt;</code>
</li>
</ul>
<p><code><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute()</a></code> ensures we don’t evaluate the generated
expression and replace <code>x</code> and <code>y</code> by their
respective values.</p>
<p>Can you spot the current point? How do we combine plot layer
expressions linked by <code>+</code> with this setup? In order to
overcome this limitation, we introduced the
<code><a href="../reference/block_combiner.html">block_combiner()</a></code>, a new generic which aims at linking
multiple block expressions depending on their class. Under the hood, we
only check the class of the <strong>right</strong> block to determine
the expression link (the S3 dispatch occurs on the second block), that
is <code>%&gt;%</code> or <code>+</code> (and maybe more in the
future).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">block_combiner</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span>, <span class="va">...</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"block_combiner"</span>, <span class="va">right</span><span class="op">)</span></span></code></pre></div>
<p>Another important modification to bring is about
<code><a href="../reference/new_stack.html">generate_code.stack()</a></code>. With the above logic,
<code><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce()</a></code> only consumes the block expressions, thereby
preventing us from being able to dispatch. We pass a vector of blocks
instead, such that we get:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_code.stack</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Handles monoblock stacks</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">aggregate_code</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/block_combiner.html">block_combiner</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">aggregate_code</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">x</span>, \<span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/generate_code.html">generate_code</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For empty stacks, the returned code is arbitrary. For stacks with one
block, we don’t need <code><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce()</a></code> and only call
<code><a href="../reference/generate_code.html">generate_code()</a></code> for the corresponding block. We create a
new internal function, that is <code>aggregate_code</code>, subsequently
calling <code><a href="../reference/block_combiner.html">block_combiner()</a></code>.</p>
<p>There is still one last issue to solve. Since we now pass blocks, we
have to find a way to let <code><a href="../reference/block_combiner.html">block_combiner()</a></code> evaluate each
block expression. We apply <code><a href="../reference/generate_code.html">generate_code()</a></code> within the
<code><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute()</a></code> call so we can inject the block expression and
not the block itself. This eventually leads us to:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">block_combiner.transform_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span></span>
<span>    <span class="va">left</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">right</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>left <span class="op">=</span> <span class="fu"><a href="../reference/generate_code.html">generate_code</a></span><span class="op">(</span><span class="va">left</span><span class="op">)</span>, right <span class="op">=</span> <span class="fu"><a href="../reference/generate_code.html">generate_code</a></span><span class="op">(</span><span class="va">right</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">block_combiner.plot_block</span> <span class="op">&lt;-</span> <span class="va">block_combiner.transform_block</span></span>
<span></span>
<span><span class="va">block_combiner.plot_layer_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span></span>
<span>    <span class="va">left</span> <span class="op">+</span> <span class="va">right</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>left <span class="op">=</span> <span class="fu"><a href="../reference/generate_code.html">generate_code</a></span><span class="op">(</span><span class="va">left</span><span class="op">)</span>, right <span class="op">=</span> <span class="fu"><a href="../reference/generate_code.html">generate_code</a></span><span class="op">(</span><span class="va">right</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Importantly, plot constructor like <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code> should have
the <code>plot_block</code> class so that the link is
<code>%&gt;%</code> (the same as for other transform blocks).</p>
</div>
</div>
<div class="section level3">
<h3 id="create-the-ggplot-block">Create the ggplot block<a class="anchor" aria-label="anchor" href="#create-the-ggplot-block"></a>
</h3>
<p>To create a new block, we call the <code><a href="../reference/new_block.html">new_block()</a></code>
constructor. It expects:</p>
<ul>
<li>
<strong>fields</strong>: a list of field, which are translated into
shiny inputs.</li>
<li>
<strong>expr</strong>: the expression returned by the block,
necessary to produce an output and export the code.</li>
<li>
<strong>name</strong>: a name (randomly choosen, you don’t need to
worry about this).</li>
<li>
<strong>class</strong>: a class to dispatch to the relevant S3
methods.</li>
<li>
<strong>layout</strong>: an optional layout (default to
<code>default_layout_fields()</code>).</li>
</ul>
<p>Our block will have <code>c("ggplot_block", "plot_block")</code> as
classes, some fields to pass mappings and we leave the layout to the
default choice. Note that the mapping field depends on the provided
data. To stay simple, we assume to only handle <code>x</code> and
<code>y</code> <strong>aesthetics</strong>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_ggplot_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/new_block.html">new_block</a></span><span class="op">(</span></span>
<span>    fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># TO DO</span></span>
<span>    <span class="op">)</span>,</span>
<span>    expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ggplot_block"</span>, <span class="st">"plot_block"</span><span class="op">)</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We finally end with the <code>new_ggplot_block</code> constructor.
The next step is to create the mappings fields with two
<code><a href="../reference/select_field.html">new_select_field()</a></code>. Those fields are converted into shiny
inputs, specifically <code><a href="https://rdrr.io/pkg/shiny/man/selectInput.html" class="external-link">selectInput()</a></code>. To set the field
choices which depend on the data, we define the <code>data_cols</code>
helper:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_cols</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<p>We modify <code>new_ggplot_block</code> such that:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_ggplot_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">col_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">col_y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">data_cols</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_block.html">new_block</a></span><span class="op">(</span></span>
<span>    fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="va">col_x</span>, <span class="va">data_cols</span>, type <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span>,</span>
<span>      y <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="va">col_y</span>, <span class="va">data_cols</span>, type <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ggplot_block"</span>, <span class="st">"plot_block"</span><span class="op">)</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Passing <code>type = "name"</code> allows to inject functions inside
the select field choices. This is useful to dynamically update the
choices whenever data change.</p>
<p>Producing the expression, which is certainly the most “technical”
part, as it involves a bit of <strong>metaprogramming</strong>. The
expression must not be evaluated in the block, that’s why it is wrapped
in a <code><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote()</a></code>. <a href="https://bristolmyerssquibb.github.io/blockr">blockr</a> is then able to
generate the expression with <code><a href="../reference/generate_code.html">generate_code()</a></code> and evaluate
it with <code><a href="../reference/evaluate_block.html">evaluate_block()</a></code>.</p>
<p>Our ggplot expression can be written as:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In the above expression, you may notice <code>.()</code>, which is
actually required by <code><a href="../reference/generate_code.html">generate_code()</a></code>. Under the hoods, this
is needed by <code><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote()</a></code> which only evaluates arguments
wrapped by <code>.()</code> with variables from the environment. It
makes it easier to use than <code><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute()</a></code>, since we
explicitly mark what we want to evaluate.</p>
<p>All combined together, this eventually yields:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_ggplot_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">col_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">col_y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">data_cols</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_block.html">new_block</a></span><span class="op">(</span></span>
<span>    fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="va">col_x</span>, <span class="va">data_cols</span>, type <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span>,</span>
<span>      y <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="va">col_y</span>, <span class="va">data_cols</span>, type <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ggplot_block"</span>, <span class="st">"plot_block"</span><span class="op">)</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>As you can, see the code base is reasonable in terms of
complexity.</p>
</div>
<div class="section level3">
<h3 id="create-a-geom-block">Create a geom block<a class="anchor" aria-label="anchor" href="#create-a-geom-block"></a>
</h3>
<p>Now that we have a valid <code>new_ggplot_block</code>, we want to
add it a geometry. The easiest one is <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point()</a></code>. To keep
the vignette as simple as possible, we only handle two options, namely
the point color and shape. We host this information in a
<code><a href="../reference/select_field.html">new_select_field()</a></code>, for instance:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="va">default</span>, <span class="va">choices</span><span class="op">)</span></span></code></pre></div>
<p>The expression is straightforward to get:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">color</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">shape</span><span class="op">)</span><span class="op">)</span> <span class="co"># Don't forget to wrap it with quote(...).</span></span></code></pre></div>
<p>Importantly, since we use <code>.(color)</code>, the field name must
be <strong>color</strong> and conversely for the shape. Also note that,
since the previous data contains the <code>ggplot</code> object, we must
extract its data located in <code>data$data</code>, such that the column
names are obtained with
<code>data_cols &lt;- function(data) colnames(data$data)</code>.</p>
<p>This finally gives us:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_geompoint_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">color</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">shape</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">data_cols</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_block.html">new_block</a></span><span class="op">(</span></span>
<span>    fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      color <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="va">color</span>, <span class="va">data_cols</span>, type <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span>,</span>
<span>      shape <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="va">shape</span>, <span class="va">data_cols</span>, type <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">color</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">shape</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"plot_layer_block"</span>, <span class="st">"plot_block"</span><span class="op">)</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note the class <code>plot_layer_block</code>. This is necessary to
invoke the corresponding <code><a href="../reference/evaluate_block.html">evaluate_block()</a></code> method (to use
<code>+</code> instead of <code>%&gt;%</code>).</p>
</div>
<div class="section level3">
<h3 id="try-it">Try it<a class="anchor" aria-label="anchor" href="#try-it"></a>
</h3>
<div class="m-3 p-2 text-primary-emphasis bg-primary-subtle border border-primary-subtle rounded-3">We currently decided that each plot layer can be visible, so that you can
  see the plot construction step by step within the UI. In any case, `{blockr}` 
  only expands the latest stack block UI so you can focus on the final result.
  Toggling other blocks is up to the end-user.</div>
<p>We can try it on the following stack:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_stack.html">new_stack</a></span><span class="op">(</span></span>
<span>  data_block <span class="op">=</span> <span class="fu"><a href="../reference/new_dataset_block.html">new_dataset_block</a></span><span class="op">(</span><span class="st">"penguins"</span>, <span class="st">"palmerpenguins"</span><span class="op">)</span>, </span>
<span>  plot_block <span class="op">=</span> <span class="fu">new_ggplot_block</span><span class="op">(</span><span class="st">"flipper_length_mm"</span>, <span class="st">"body_mass_g"</span><span class="op">)</span>,</span>
<span>  layer_block <span class="op">=</span> <span class="fu">new_geompoint_block</span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"species"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/new_stack.html">serve_stack</a></span><span class="op">(</span><span class="va">stack</span><span class="op">)</span></span></code></pre></div>
<div class="card bslib-card bslib-mb-spacing html-fill-item html-fill-container" data-bslib-card-init data-full-screen="false" data-require-bs-caller="card()" data-require-bs-version="5" id="bslib-card-2243">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
<iframe class="html-fill-item" src="https://shinylive.io/r/app/#code=NobwRAdghgtgpmAXGKAHVA6ASmANGAYwHsIAXOMpMAdzgCMAnRRASwgGdSoAbbgCgA6YOtyIEA1gyG4ABAzioi7GQF4ZBQWAAWpUqnaIA9IcYtORbjACecBu3YBHAK4s6dDAHMWpLU-csiQ1pGAFp5RXZpGSEdPQNjcKIMBhDqKHYYDCIGDyEASjyBCCLuVwYoBis+ETFJQohSxgqq1B54BlQKDxcOesbyyr4PD1RRUgAmeqKIOGoAfWHRolI5mokZAB4QmQAzJwgCUgCIPmJuOYAPVXUtCqhD2z482TO5q2uCW-KHhifZDABeRkICKRRkMgAJlAuHMzsotrt9odjnwoVwgWdoPB2KjoVAphBwTN5mtxIJCeDdiw4NwIco1KVOOTKZSrmpiXN2DS4Ic5jtqbTThZLrI0VBYRZ2LJSFZOtchFi4PlcGCWTJ3uzZpzubz+TSIULzlZRXiJdwpTIZXK1ArYEqwPUWc9VeC4BdUAxrs5lnBmWrFmM+DA0Kg2B5rlA4Di2TIMHwLs91dc41YCo7Kc6KeCCNx0vT1JoA8tVqIJFEhEsVqTlS7YwDVfUAL6giAcjxwIgwRRsKul8SbbZ7A5HEiG7IfL73ci-RPsW7Wm53H5-OsYIEg4oUsVm+GDpEjk5ijEWRU4sUAEiPLaJWtJfvBetp+cZpHvlLO4818y53B5K0fBofgwJownC0qynA8qQHaNZZpSc5oJBX7ar+uoCgaCGdCB4pgZaEFQYq+S1pmLJuh6XpOD6b7gu2nZzN2ZB8JGOJAcmY4MLO85IbGfCYXABSyOwLAAF7cZMxEqnBOZ5h8miVnMuY2AwJa1OWYDydWDqSSyAIYA2RTNpunD3P2CIcsZEh+tupLXByYpcr2tRyV0PSRHg0TqW0tidBA3RsG5JEyBpfa2VqRaOZZQg7KU6C2ApXQ+HMMAwGpdBEBCVhJXmCyweCilxTZyG0V2RA9ipkVgOwnQENSbmyEIVU8rVREQPUXIMAAbnAnJcJZFniPUYCNgAukAA&amp;h=0" height="700" width="100%" style="border: 1px solid rgba(0,0,0,0.175); border-radius: .375rem;" allowfullscreen="" allow="autoplay" data-external="1"></iframe>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()"><template>Expand</template><button aria-expanded="false" aria-label="Expand card" class="bslib-full-screen-enter badge rounded-pill"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;fill:currentColor;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg></button>
</bslib-tooltip><script data-bslib-card-init>bslib.Card.initializeAllCards();</script>
</div>
</div>
<div class="section level3">
<h3 id="going-further">Going further<a class="anchor" aria-label="anchor" href="#going-further"></a>
</h3>
Below is a possible implementation of an interactive
<a href="https://davidgohel.github.io/ggiraph/" class="external-link">ggiraph</a> <a href="https://davidgohel.github.io/ggiraph/#with-r-and-r-markdown" class="external-link">plot</a>.
<p class="text-center">
<a class="btn btn-primary" data-bs-toggle="collapse" href="#ggiraphBlockr" role="button" aria-expanded="false" aria-controls="ggiraphBlockr"> Toggle code </a>
</p>
<div id="ggiraphBlockr" class="collapse">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bristolmyerssquibb.github.io/blockr">blockr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidgohel.github.io/ggiraph/" class="external-link">ggiraph</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">custom_data_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/new_dataset_block.html">new_dataset_block</a></span><span class="op">(</span></span>
<span>    <span class="va">...</span>,</span>
<span>    selected <span class="op">=</span> <span class="st">"mtcars"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">new_ggplot_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">data_cols</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_block.html">new_block</a></span><span class="op">(</span></span>
<span>    fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="st">"wt"</span>, <span class="va">data_cols</span>, type <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span>,</span>
<span>      y <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="st">"qsec"</span>, <span class="va">data_cols</span>, type <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span>,</span>
<span>      color <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span><span class="st">"disp"</span>, <span class="va">data_cols</span>, type <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, color <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">color</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ggplot_block"</span>, <span class="st">"plot_block"</span><span class="op">)</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># We could have use a mutate_block instead of</span></span>
<span><span class="co"># changing the data from inside the block ...</span></span>
<span><span class="co"># {blockr} is flexible here.</span></span>
<span><span class="va">new_geompoint_interactive_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">build_expr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Get data from the previous ggplot layer</span></span>
<span>    <span class="co"># data is the ggplot so we need to use data$data</span></span>
<span>    <span class="co"># to get the initial data</span></span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">data</span></span>
<span>    <span class="va">dat</span><span class="op">$</span><span class="va">carname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span></span>
<span>      <span class="fu">geom_point_interactive</span><span class="op">(</span></span>
<span>        <span class="co"># Pass in new data</span></span>
<span>        data <span class="op">=</span> <span class="va">new_data</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>          tooltip <span class="op">=</span> <span class="va">carname</span>,</span>
<span>          data_id <span class="op">=</span> <span class="va">carname</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_block.html">new_block</a></span><span class="op">(</span></span>
<span>    fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      expression <span class="op">=</span> <span class="fu"><a href="../reference/hidden_field.html">new_hidden_field</a></span><span class="op">(</span><span class="va">build_expr</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span><span class="va">expression</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"plot_layer_block"</span>, <span class="st">"plot_block"</span><span class="op">)</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">new_theme_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/new_block.html">new_block</a></span><span class="op">(</span></span>
<span>    fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      theme <span class="op">=</span> <span class="fu"><a href="../reference/select_field.html">new_select_field</a></span><span class="op">(</span></span>
<span>        <span class="st">"theme_minimal"</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^theme_.*$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="st">"package:ggplot2"</span><span class="op">)</span>, perl <span class="op">=</span> <span class="cn">TRUE</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"name"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span></span>
<span>      <span class="fu">.</span><span class="op">(</span><span class="va">theme</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"plot_layer_block"</span>, <span class="st">"plot_block"</span><span class="op">)</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">new_ggiraph_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/new_block.html">new_block</a></span><span class="op">(</span></span>
<span>    fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      pointsize <span class="op">=</span> <span class="fu"><a href="../reference/numeric_field.html">new_numeric_field</a></span><span class="op">(</span><span class="fl">12</span>, min <span class="op">=</span> <span class="fl">1</span>, max <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">girafe</span><span class="op">(</span>ggobj <span class="op">=</span> <span class="va">data</span>, pointsize <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">pointsize</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ggiraph_block"</span>, <span class="st">"plot_block"</span><span class="op">)</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Necessary to get ggiraph plot rendering</span></span>
<span><span class="va">uiOutputBlock.ggiraph_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">ns</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">ggiraph</span><span class="fu">::</span><span class="fu">girafeOutput</span><span class="op">(</span><span class="fu">ns</span><span class="op">(</span><span class="st">"plot"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">server_output.ggiraph_block</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">result</span>, <span class="va">output</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">ggiraph</span><span class="fu">::</span><span class="fu">renderGirafe</span><span class="op">(</span><span class="fu">result</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_stack.html">new_stack</a></span><span class="op">(</span></span>
<span>  <span class="va">custom_data_block</span>,</span>
<span>  <span class="va">new_ggplot_block</span>,</span>
<span>  <span class="va">new_geompoint_interactive_block</span>,</span>
<span>  <span class="va">new_theme_block</span>,</span>
<span>  <span class="va">new_ggiraph_block</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/new_stack.html">serve_stack</a></span><span class="op">(</span><span class="va">stack</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nicolas Bennett, David Granjon, John Coene, Bristol Myers Squibb.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
